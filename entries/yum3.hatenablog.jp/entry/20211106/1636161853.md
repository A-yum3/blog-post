---
Title: Laravelでテストコードを書く(Pest)
Date: 2021-11-06T10:24:13+09:00
URL: https://yum3.hatenablog.jp/entry/20211106/1636161853
EditURL: https://blog.hatena.ne.jp/noikari/yum3.hatenablog.jp/atom/entry/13574176438030075644
Draft: true
---

テストの勉強をしていて、振る舞いをテストする（BDD）の例えに感銘を受けたのでPHPUnitから[Pest](https://pestphp.com/)への乗り換えを考え始めたので勉強しました。

振る舞い検証の例
> 私が犬を呼ぶと、犬はすぐに私のところに来る。

コード検証の例
> 私が犬を呼ぶと、犬はまず左前足を動かし、次に右前足を動かし、頭を動かし、尻尾を動かす。
> そして足を動かし、頭を回転させ、尻尾を振って・・・

<!-- more -->

[:contents]

## テストの基本

### BDDとは

**BDD（ビヘイビアー駆動開発）** はTDDを拡張した手法です。1つのシナリオを書き、そのシナリオを満たすように実装を進めていきます。つまり、ユニットテストの範囲は単一クラスではなく、複数の依存関係にあるクラスも含みます。
基本的にビジネスマン（非エンジニア）から見たとしても理解ができるテストであり、受け入れテストとも言われます。
詳細に言うと、[受け入れテスト（ATDD）はユーザー寄りで、振る舞い駆動開発（BDD）は開発者寄りと見る人もいます。](https://ukstudio.jp/2011/07/02/bdd/)

どちらかというとUIテストに使われる傾向があり、[「Given-When-Then」パターン](https://bowbow99.hatenadiary.org/entry/20090523/1243043153)などが手法として有名どころです。

また、ツールとしては[RSpec](https://rspec.info/), [Jest](https://jestjs.io/ja/)等が有名です。

### ユニットテストの考え方と派閥

詳しい話は本題から逸れるため、ざっくりまとめの説明にします。この部分はまた別の機会の記事として書くつもりです。

#### ロンドン派

- テスト対象の依存関係をすべてモックに置き換える（自クラス以外は全部モック）
- ユニットテストの単位はクラス（1度に1つのクラスだけチェック）
- コードを検証する
- 不変的な（EnumやConst）依存関係以外はモックをする
- 単一クラスで完結しないクラスは結合テストとして扱う

ロンドン派の例
> 私が犬を呼ぶと、犬はまず左前足を動かし、次に右前足を動かし、頭を動かし、尻尾を動かす。
> そして足を動かし、頭を回転させ、尻尾を振って・・・
> 引用:[Unit Testing Principles, Practices, and Patterns: ...](https://amzn.to/3o2euAx)

##### メリット

- 粒度が細かい
  - テストが細かく、1度に1つのクラスだけをチェックするので隅から隅までテストになる
- 依存関係が複雑な場合でも容易にテストできる
  - モックに置き換えるだけで良いのでテストが簡単に書ける
- テスト失敗時にどの機能がバグを出しているかを簡単に見つけられる
  - 単一クラスのみテストを書くので、失敗時どのクラスが悪影響を与えているかがわかる

##### ロンドン派の代表書籍

- [実践テスト駆動開発](https://amzn.to/3EQSAqF)

#### デトロイト派（古典派）

- テスト対象の依存関係は共有依存関係だけモックにする
  - 共有依存関係とは、ユニットテスト間で共有されるもの（データベースなど）
- ユニットテストの単位は1つの振る舞い（同時に複数クラスがまたがるテストもある）
- 動作（振る舞い）を検証する
- 他のテストとは切り離して実行する（テスト同士は違いに影響しない）
- 2つ以上の動作単位を検証する場合は統合テストとして扱う

デトロイト派の例
> 私が犬を呼ぶと、犬はすぐに私のところに来る。
> 引用:[Unit Testing Principles, Practices, and Patterns: ...](https://amzn.to/3o2euAx)

##### メリット

- 依存関係が複雑な場合のテストは難しい
  - 難しいということは設計を見直す必要があり、良い設計に繋がる
- 1つの動作を担保できる
  - 統合時にバグが起きる危険性を排除できる
- テストコードがドキュメントになる
  - 動作単位を書くと言うことは、アプリがどのような振る舞いを持つのかわかる

##### デトロイト派の代表書籍

- [テスト駆動開発](https://amzn.to/3k6tfRJ)

### TDDと流派

みんな大好きテスト駆動開発（TDD）ですが、ロンドン派かデトロイト派かでアプローチの方法が変わります。

ロンドンスタイルのTDDは**アウトサイドイン型**のアプローチを取ります。
関係するクラスはすべてモックとして実装して処理は後回しにし、1つのクラスの実装に注力します。

デトロイトスタイルのTDDは**インサイドアウト型**のアプローチを取ります。
ドメインモデルから実装を始め、どんどんレイヤーを重ねていきます。

重要な違いは**テストと実装の結合度**です。
ロンドンスタイルでは、実装と結合するテストを作成する傾向にあるのでテストの保守性が大きく下がってしまいます。
さらにモックを使っているということは、クラスAを使用しているクラスBがある時、クラスAの実装を変えたとしても、クラスBはクラスAをモックしている（返却値が一定）ので、クラスAの変更に対するテストができません。
テストも落ちることがなく、正常に実行されたと結果を出すため、発見がしにくく、過去の仕様をテストし続けるテストコードが生き残り続けます。
ロンドン派のアプローチ的にはこの変更は統合テストで検出すべきだと考えていますが、二重でテストすることになるので、変更があった際の修正箇所が増えてしまい、メンテナンスコストが上がってしまいます。
メンテナンスコストが上がってしまうということは、**テストが修正されなくなってしまい（テスト削除やテストスキップによる）結果、テストの意味が失われてしまう**ことに繋がります。
実装を変更してテストが変更されないなんてあるわけないじゃん・・・と思う人もいるとは思いますが、すべての人がテストに対するベストプラクティスを知っているわけではないですし、軽視している人もいます。
どこまで不安要素を取り除けるか、そのためにはどうすればいいか？を考えるのが重要になっていきます。

#### TDD + デトロイト = BDD

動作を検証するスタイルのデトロイト派とTDDを組み合わせたものがBDDとなります。
BDDは動作を検証することに重きが置かれているので、BDDフレームワークと言われるJestやRSpecには便利なヘルパーメソッドが容易されています。
`it`や`toBe`から始まるアサーションメソッドが多いのもその特徴です。
ここで勘違いしてしまいがちなのですが、**TDDフレームワーク（xUnit系）だからBDDが出来ないことはないです。**
少し手間がかかりますがxUnit系でもBDDはできます。ただの手法なので技術は問わないのです。
ただ自由すぎてしまうので秩序が乱れやすいです。それをある程度矯正するためのBDDフレームワークです。

## Pest

### Pestとは？

[Pest](https://pestphp.com/)とは2020年の初めにOSSとなったPHPUnitに代わるテストフレームワークです。
テストを簡単にし、読みやすく、理解しやすいものにします。
シンプルさに焦点を当てているため、テストを書くのが楽しくなります。
Laravelに限られず、PHPであれば利用ができます。（composerで）
また、JestのようなBDDフレームワーク系統の拡張ですが、xUnit系の書き方もできます。
柔軟なテストフレームワークです。

基本的な機能は揃っています。（プラグインで対応）

- Laravel最適化
- Livewire適用
- モック
- Faker
- データセット（PHPUnitで言うDataProvider）

基本的にPHPUnitの拡張になるのでPHPUnitはラップしていると考えても良さそうです。

### 準備

[インストール](https://pestphp.com/docs/installation)
ドキュメントがあるのでそちらを参照してください。

[Laravelで使う](https://pestphp.com/docs/plugins/laravel)
Laravel用のプラグインが用意されています。（artisanコマンドなど）

[IDE-Plugin](https://pestphp.com/docs/ide-plugins)
IDEで使えないと話になりません。各プラグインは用意されています。

### テスト

#### テストを書く

[Writing Tests](https://pestphp.com/docs/writing-tests)

テストを書く方法になります。
PHPUnitだと`Tests\TestCase`を継承するクラスを作成し、`public function testXXX`のように書き始めるか、`@test`のアノテーションを作ってメソッドを作ります。
**Pestはクラスを必要としません。**
`test()`か`it()`でメソッドを作成すればテストになります。

```test.php
test('asserts true is true', function () {
    $this->assertTrue(true);

    expect(true)->toBeTrue();
});
```

```it.php
it('asserts true is true', function () {
    $this->assertTrue(true);

    expect(true)->toBeTrue();
});
```

`test()`と`it()`はほとんど一緒です。ただし、`it()`を利用すると、テスト実行した時第一引数に指定した動作説明の前にitが自動的に付きます。
英語で動作説明を書くのであれば良いでしょうが日本語でテストを書く場合だと`test()`を利用する方のが違和感はないかもしれません・・・。

#### テストケースの基礎

[Underlying Test Case](https://pestphp.com/docs/underlying-test-case)

Laravelだと`Tests\TestCase`を継承しなきゃいけないんだけど・・・。と思う人がいると思います。
Pestではデフォルトだと`PHPUnit\Framework\TestCase`にバインドされているため、`uses()`で指定する必要があります。
Laravelプラグインを入れて、`php artisan pest:install`をするとtests/Pest.phpがインストールされ、そこにFeatureディレクトリ内は最初からusesするように設定されています。

```Pest.php
uses(Tests\TestCase::class)->in('Feature');
```

別な場所にも適応したい人は適宜設定を行いましょう。

この`uses()`が便利で`uses()->in()`としてしまえば対象ディレクトリに一括でトレイト指定もできます。
`uses()->beforeEach()`とすればPHPUnitで言う`setUp()`と同等のこともできます。詳しくは試してみてください。

#### アサーション

[Assertions](https://pestphp.com/docs/assertions)

- `assertTrue()`
- `assertFalse()`
- `assertCount()`
- `assertEquals()`
- `assertEmpty()`
- `assertStringContainsString()`

基本的なものは揃っています。しかしPHPUnitと比べると「少なくね？」と思う人もいると思います。
前述の通り、PestはBDDフレームワークです。assertよりもexpectationsメソッドのが充実しています。

#### 期待

[Expectations](https://pestphp.com/docs/expectations)

`expect($value)`から始まり、arrowでチェインさせて書いていきます。

### 役に立ちそうなリンク

- GitHub WorkFlowでPestする
  - [How to Automatically Run Your Laravel PestPHP Tests on Each GitHub Pull Request?](https://devdojo.com/bobbyiliev/how-to-automatically-run-your-laravel-pestphp-tests-on-each-github-pull-request)